{% extends "base.html" %}
{% block title %}Menu2 - Poring AI{% endblock %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<style>
  :root {
    --sheet-max-h: 60vh;
    --safe-bottom: max(16px, env(safe-area-inset-bottom)); /* 하단 여백 */
    --search-h: 44px;                                       /* 검색바 높이 */
  }
  /* 레이아웃 */
  .map-wrap {
    position: relative;
    width: 100%;
    /* 헤더 높이(56px) + 하단 안전여백만큼 제외 */
    height: calc(100vh - 56px - var(--safe-bottom));
    padding-bottom: var(--safe-bottom); /* 지도 아래 살짝 공간 생김 */
  }
  #map { width: 100%; height: 100%; }

  /* 떠있는 액션버튼(FAB) */
  .fab {
    position: absolute; right: 12px; z-index: 1000;
    display: grid; gap: 10px;
  }
  .fab.top { top: 12px; }
  .fab.bottom { bottom: 12px; }
  .btn-fab {
    padding: 10px 12px; border-radius: 999px; border: 1px solid #ddd;
    background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,.12);
    font-size: 14px; line-height: 1; cursor: pointer; user-select: none;
  }
  .btn-fab:active { transform: translateY(1px); }

  /* 바텀시트 */
  .sheet {
    position: absolute; left: 0; right: 0; 
    bottom: var(--safe-bottom);                 /* 시트도 하단 여백 반영 */
    z-index: 1100;
    background: #fff; border-top-left-radius: 16px; border-top-right-radius: 16px;
    box-shadow: 0 -8px 24px rgba(0,0,0,.12);
    max-height: var(--sheet-max-h); transform: translateY(100%);
    transition: transform .25s ease;
    touch-action: none;
  }
  .sheet.open { transform: translateY(0); }
  .sheet-handle {
    width: 44px; height: 5px; border-radius: 3px; background: #ccc; margin: 8px auto;
  }
  .sheet-body {
    padding: 12px 16px; overflow: auto; max-height: calc(var(--sheet-max-h) - 24px);
  }
  .poi-title { font-weight: 700; margin: 2px 0 6px; font-size: 16px; }
  .tag { display:inline-block; margin:2px 6px 2px 0; padding:2px 8px; border:1px solid #e2e2e2;
         border-radius:12px; font-size:12px; background:#fafafa; }
  .meta { color:#666; font-size:13px; }

  /* 상단 검색바(선택) */
  .search-bar {
    position: absolute; left: 12px; right: 84px; top: 12px; z-index: 1000;
    height: var(--search-h);
    background: #fff; border: 1px solid #ddd; border-radius: 999px;
    display: flex; align-items: center; padding: 6px 12px; gap: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,.10);
  }
  .search-bar input {
    border: none; outline: none; flex: 1; font-size: 14px;
  }

  /* 데스크톱에선 시트 대신 우측 고정 패널 */
  @media (min-width: 992px) {
    .map-wrap { height: calc(100vh - 80px); }
    .sheet { width: 360px; right: 12px; left: auto; border-radius: 12px;
             bottom: 12px; max-height: 70vh; transform: translateY(0); display: none; }
    .sheet.open { display: block; }
  }
</style>

<div class="map-wrap">
  <!-- 상단 검색(선택 기능: 이름으로 필터) -->
  <div class="search-bar">
    <input id="q" type="text" placeholder="허브 이름 검색..." aria-label="검색"/>
    <button class="btn-fab" id="btnClear">지우기</button>
  </div>

  <div id="map"></div>

  <!-- 우측 상단 FAB: 레이어/리셋 -->
  <div class="fab top">
    <button class="btn-fab" id="btnResetView">초기화</button>
  </div>

  <!-- 우측 하단 FAB: 현재 위치 -->
  <div class="fab bottom">
    <button class="btn-fab" id="btnLocate">현재 위치</button>
  </div>

  <!-- 바텀시트: 마커 클릭 시 내용 표시 -->
  <div class="sheet" id="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-body" id="sheetBody">
      <div class="meta">마커를 탭하면 상세 정보가 보입니다.</div>
    </div>
  </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  // 서버에서 전달된 허브 데이터
  const HUBS = {{ hubs|tojson }};

  // 초기 중심(원하면 서버에서 계산해서 전달 가능)
  const INIT = { lat: 36.0129, lng: 129.3245, zoom: 16 };

  // 지도 생성
  const map = L.map('map', { zoomControl: false }).setView([INIT.lat, INIT.lng], INIT.zoom);

  // 줌 컨트롤을 좌하단으로
  L.control.zoom({ position: 'bottomleft' }).addTo(map);

  // 타일
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // 마커 그룹 (필터/fitBounds용)
  const group = L.featureGroup().addTo(map);

  // 점유율에 따라 마커 색 구분
  function markerColor(parked, total) {
    if (!total || total <= 0) return '#666';
    const r = parked / total;
    if (r >= 0.9) return '#e53935';    // 매우 혼잡
    if (r >= 0.7) return '#fb8c00';    // 혼잡
    if (r >= 0.4) return '#43a047';    // 보통
    return '#1e88e5';                  // 여유
  }

  // SVG 원형 커스텀 아이콘
  function circleIcon(color) {
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36">
        <circle cx="18" cy="18" r="12" fill="${color}" opacity="0.9"/>
        <circle cx="18" cy="18" r="14" fill="white" opacity="0.12"/>
      </svg>`;
    return L.divIcon({ html: svg, className: 'circle-pin', iconSize: [36,36], iconAnchor: [18,18] });
  }

  // 바텀시트 엽/닫 + 내용
  const sheet = document.getElementById('sheet');
  const sheetBody = document.getElementById('sheetBody');
  function openSheet(h) {
    sheet.classList.add('open');
    const perc = h.total_sum ? Math.round((h.parked_sum / h.total_sum) * 100) : 0;
    sheetBody.innerHTML = `
      <div class="poi-title">${h.hub_name ?? 'Hub #' + h.hub_id}</div>
      <div class="meta">좌표: ${(+h.latitude).toFixed(6)}, ${(+h.longitude).toFixed(6)}</div>
      <div style="margin-top:8px;">주차 현황: <b>${h.parked_sum} / ${h.total_sum}</b> (${perc}%)</div>
      <div style="margin-top:8px;">
        <span class="tag">#hub_id:${h.hub_id}</span>
        <span class="tag">#postech</span>
      </div>
      <hr/>
    `;
  }
  function closeSheet(){ sheet.classList.remove('open'); }

  // 바텀시트 드래그로 닫기(간단)
  let startY = null;
  sheet.addEventListener('touchstart', (e)=>{ startY = e.touches[0].clientY; }, {passive:true});
  sheet.addEventListener('touchmove', (e)=>{
    if(startY===null) return;
    const dy = e.touches[0].clientY - startY;
    if (dy > 40) closeSheet();
  }, {passive:true});
  sheet.addEventListener('click', (e)=>{
    // 바깥 여백 클릭 시 닫히지 않게 유지
  });

  // 마커 렌더
  let markers = [];
  function renderMarkers(data){
    group.clearLayers();
    markers = [];
    data.forEach(h=>{
      const color = markerColor(h.parked_sum ?? 0, h.total_sum ?? 0);
      const m = L.marker([+h.latitude, +h.longitude], { icon: circleIcon(color) })
        .on('click', ()=> openSheet(h));
      m.addTo(group);
      markers.push(m);
    });
    if (data.length) map.fitBounds(group.getBounds().pad(0.2));
  }

  renderMarkers(HUBS);

  // 검색: 허브명 포함 필터
  const q = document.getElementById('q');
  const btnClear = document.getElementById('btnClear');
  function applyFilter(){
    const term = (q.value || '').trim().toLowerCase();
    const filtered = term ? HUBS.filter(h => (h.hub_name||'').toLowerCase().includes(term)) : HUBS;
    closeSheet();
    renderMarkers(filtered);
  }
  q.addEventListener('input', applyFilter);
  btnClear.addEventListener('click', ()=>{ q.value=''; applyFilter(); q.focus(); });

  // 초기화
  document.getElementById('btnResetView').addEventListener('click', ()=>{
    closeSheet();
    map.setView([INIT.lat, INIT.lng], INIT.zoom);
  });

  // 현재 위치
  document.getElementById('btnLocate').addEventListener('click', ()=>{
    if (!navigator.geolocation) return alert('이 기기에서 위치를 사용할 수 없어요.');
    navigator.geolocation.getCurrentPosition(pos=>{
      const { latitude, longitude } = pos.coords;
      L.circle([latitude, longitude], { radius: 25 }).addTo(map);
      map.setView([latitude, longitude], 17);
    }, err=>{
      alert('위치 권한이 거부되었어요.');
    }, { enableHighAccuracy: true, timeout: 5000 });
  });

  // 지도 클릭 시 시트 닫기
  map.on('click', closeSheet);
</script>
{% endblock %}
